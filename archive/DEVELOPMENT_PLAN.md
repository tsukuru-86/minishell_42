# Minishell 開発プラン (2025年6月14日版)

## 📊 現在の状況分析

### プロジェクト概要
- **プロジェクト名**: minishell (42東京課題)
- **開発期間**: 2025年4月〜6月（現在進行中）
- **技術スタック**: C言語、42 Norm準拠、readline library
- **アーキテクチャ**: モジュラー設計（トークナイザー→前処理→パーサー→実行エンジン）

### 最近の成果 ✅ (2025年6月14日完了)
1. **Phase 1: 安定性確保 - 完全達成**
   - SEGFAULT完全解消: 基本的なechoコマンド系で100%成功
   - 構文エラー処理修正: 不正構文で適切にexit status 2を返す
   - トークナイザー堅牢化: `safe_create_token`関数の実装と適用
   - メモリ管理強化: 構文エラー時のメモリリーク解消
   - 入力処理安全性向上: NULL/空文字列チェックの強化

2. **基本機能の安定化完了**
   - 空コマンド・空文字列処理の堅牢化
   - リダイレクトエラー処理の改善
   - 基本的なパイプライン処理の動作
   - AddressSanitizer環境でのメモリ安全性確保

3. **開発基盤の整備完了**
   - 包括的なREADME.md作成
   - トークン前処理システムの詳細ドキュメント化
   - 開発ルールとアーキテクチャ文書化
   - Norm準拠開発フローの確立

### 現在の状況分析 (2025年6月14日時点)

#### ✅ 完了済み課題
**Phase 1: 安定性確保 - 100%完了**
- ✅ SEGFAULT完全解消
- ✅ 構文エラー処理修正 (exit status 2)
- ✅ トークナイザー堅牢化
- ✅ メモリ管理強化
- ✅ Norm準拠達成

#### 🎯 次期課題 (Phase 2)

**1. Heredoc機能の未実装**
- **現状**: `<<` 演算子が全くの未実装（status 127）
- **影響**: シェルの基本機能として必須
- **修正優先度**: 最高

**2. Export機能の高度化不足**
- **未実装機能**: `+=` 演算子、複雑なスペース処理
- **影響範囲**: 環境変数管理の利便性
- **修正対象**: Export関連モジュール

**3. 環境変数展開の不完全性**
- **問題**: 未定義変数の展開時のスペース処理
- **修正対象**: 環境変数展開ロジック

## 🎯 短期目標（1-2週間）

### Phase 2: 機能完成度向上 (現在のフォーカス)

#### 2.1 Heredoc機能の完全実装 (1週間) - 🎯 現在の最優先
**現状**: `<<` 演算子が全くの未実装（status 127）

**対象ファイル**:
- [`srcs/parser/heredoc.c`](srcs/parser/heredoc.c)
- [`srcs/parser/heredoc_utils.c`](srcs/parser/heredoc_utils.c)
- [`srcs/parser/heredoc_process.c`](srcs/parser/heredoc_process.c)

**実装ロードマップ**:
1. **デリミタ解析機能** (1-2日)
   - 引用符付きデリミタの処理
   - 変数展開の要否判定

2. **一時ファイル管理** (2日)
   - 安全な一時ファイル作成
   - プロセス終了時の自動クリーンアップ

3. **入力処理ループ** (2-3日)
   - 複数行入力の処理
   - Ctrl-C/Ctrl-Dシグナル処理

**検証テストケース**:
```bash
cat << EOF
line1
line2
EOF

cat << 'DELIMITER'
no variable expansion: $USER
DELIMITER

cat << "DELIMITER"
variable expansion: $USER  
DELIMITER
```

#### 2.2 Export機能の高度化 (3-4日)
**未実装機能**: `+=` 演算子、複雑なスペース処理

**対象ファイル**:
- [`srcs/builtin/builtin_export_set.c`](srcs/builtin/builtin_export_set.c)
- [`srcs/builtin/builtin_export_utils.c`](srcs/builtin/builtin_export_utils.c)

**実装項目**:
```c
// += 演算子の実装
int handle_append_operator(char *name, char *value)
{
    t_env *existing = get_env_node(name);
    if (existing)
        append_to_existing_value(existing, value);
    else
        create_new_env_variable(name, value);
}

// 引用符内スペースの適切な処理
export VAR="value with spaces"
export VAR+=" additional value"
```

#### 2.3 環境変数展開の強化 (3-4日)
**問題**: 未定義変数の展開時のスペース処理

**対象ファイル**:
- [`srcs/env/env_expand.c`](srcs/env/env_expand.c)
- [`srcs/parser/parser_preprocess.c`](srcs/parser/parser_preprocess.c)

**修正内容**:
```c
// 空の環境変数での引数消失問題の修正
char *expand_env_var(char *var_name)
{
    t_env *env = get_env_node(var_name);
    if (!env)
        return NULL;  // 空文字列ではなくNULLを返す
    return ft_strdup(env->value);
}
```

### Phase 2 完了基準
- Heredoc機能の完全動作
- Export += 演算子の実装
- 環境変数展開の bashレベル互換性
- テスターでの成功率70%以上

## 🏗️ 長期目標（2-3ヶ月）

### Phase 3: 高度機能とボーナス実装

#### 3.1 Bonusパート実装検討 (2週間)
**検討項目**:
1. **ワイルドカード展開** (`*.c`, `*.h`)
2. **論理演算子** (`&&`, `||`)
3. **括弧による優先順位** (`(command1 && command2) || command3`)
4. **ジョブ制御** (Ctrl-Z サポート)

**実装優先度判定基準**:
- 実装コスト vs 学習効果
- 42課題の評価への影響度
- 既存コードベースとの互換性

#### 3.2 高度なbash互換性 (1週間)
**対象機能**:
```bash
# bash特有の展開
echo $'hello\tworld'  # エスケープシーケンス展開
echo $"hello $USER"   # 特殊変数展開

# 複雑なクオート組み合わせ
echo "hello"'world'"$USER"'test'

# 高度なリダイレクション
command 2>&1 | another_command
```

#### 3.3 パフォーマンス最適化 (3-4日)
**最適化項目**:
1. **メモリ使用量削減**
   - 不要な文字列コピーの削減
   - 効率的なトークン管理

2. **実行速度向上**
   - パーサーアルゴリズムの最適化
   - システムコール回数の削減

3. **大容量データ処理**
   - 長大なコマンドラインの処理
   - 大量パイプライン処理の安定化

### Phase 3 完了基準
- Bonusパート機能の選択的実装
- プロダクションレベルの安定性
- 大規模テストでの100%安定動作

## 📋 優先度付きタスクリスト

### 🔴 Priority 1 (今週中) - Phase 2 実装
| タスク | 工数 | 担当モジュール | 完了基準 |
|--------|------|----------------|----------|
| Heredoc実装 | 1週間 | parser/heredoc | <<演算子完全動作 |
| Export += 実装 | 3-4日 | builtin/export | += 演算子動作 |
| 環境変数修正 | 3-4日 | env, parser | 空変数の適切な処理 |

### � Priority 2 (今月中) - Phase 3 準備
| タスク | 工数 | 担当モジュール | 完了基準 |
|--------|------|----------------|----------|
| Bonus機能検討 | 2週間 | 新規モジュール | 実装可否の判定 |
| bash互換性向上 | 1週間 | env, parser | bash準拠レベル90%+ |
| パフォーマンス最適化 | 3-4日 | 全モジュール | 大容量データ処理対応 |

### ✅ Priority 0 (完了済み) - Phase 1
| タスク | 工数 | 担当モジュール | 完了基準 | 状況 |
|--------|------|----------------|----------|------|
| SEGFAULT解消 | 3-4日 | tokenizer, utils | echo系コマンド100%成功 | ✅ 完了 |
| 構文エラー修正 | 2-3日 | parser, main_loop | 不正構文でstatus 2 | ✅ 完了 |
| Norm準拠修正 | 1日 | 全ファイル | norminette エラー0件 | ✅ 完了 |

## 🛠️ 開発インフラと工程管理

### 日次開発フロー
```bash
# 1. 朝の状況確認
cd minishell_tester && ./tester | head -50
cd .. && norminette *.h srcs/

# 2. 1つのタスクに集中して作業
# 3. 修正後の確認
make re
cd minishell_tester && ./tester && cd ..

# 4. 1日の終わりにコミット
git add . && git commit -m "Fix: [具体的な修正内容]"
```

### 週次レビュー項目
- [ ] テスター成功率の向上確認
- [ ] Norm準拠状況チェック
- [ ] メモリリーク検証 (Valgrind)
- [ ] 新機能の動作確認
- [ ] 次週タスクの優先順位見直し

### 品質管理基準

#### コード品質
- **Norm準拠**: 100%必須
- **関数設計**: 単一責任原則
- **エラー処理**: 一貫したperror()使用
- **メモリ管理**: リーク0、ダブルフリー防止

#### テスト基準
- **基本機能**: 100%動作必須
- **エラー処理**: 適切なexit status
- **エッジケース**: 空入力、長大入力
- **互換性**: bash参照動作

## 🎯 マイルストーンと目標設定

### Week 1 Milestone: Phase 2 機能実装 ✅ 進行中
**目標**: Heredoc機能とExport高度化の完全実装
**成功基準**: 
- Heredoc (`<<`) 演算子の完全動作
- Export `+=` 演算子の実装
- 環境変数展開の適切な処理

### Week 2-3 Milestone: 統合テストと品質向上 (更新)
**目標**: 実装した機能の統合と安定化
**成功基準**:
- 全機能統合テスト完了
- テスター成功率80%以上
- bash互換性の大幅向上

### Week 4-8 Milestone: Phase 3とBonus実装 (更新)
**目標**: 高度機能とBonus機能の選択的実装
**成功基準**:
- 選択したBonus機能の完全動作
- プロダクションレベル安定性
- テスター成功率90%以上

### Final Milestone: 課題提出準備 (変更なし)
**目標**: 42課題としての完成度
**成功基準**:
- 全mandatory要件100%満足
- 選択したBonus機能の完全動作
- ドキュメント完成度

## ⚠️ リスク管理と対応策

### 技術的リスク

#### Risk 1: 42 Norm制約による実装困難
**対応策**: 
- 複雑な機能を小関数に分割
- 関数内static変数の活用
- ヘルパー関数による機能分散

#### Risk 2: 複雑なbash互換性要求
**対応策**:
- 段階的実装によるリスク分散
- 最低限機能の優先実装
- テストケース駆動開発

#### Risk 3: メモリ管理の複雑化
**対応策**:
- Valgrindを用いた継続的検証
- エラー処理パスの徹底テスト
- 統一的なメモリ管理方針

### スケジュールリスク

#### Risk 1: 予想以上の実装時間
**対応策**:
- 日次進捗確認とタスク調整
- 機能の優先度再評価
- 必要に応じたBonus機能の削減

#### Risk 2: デバッグ時間の延長
**対応策**:
- 小さな単位での確認とテスト
- デバッグツールの積極活用
- ペアプログラミングによる知見共有

## 📈 期待される成果

### 短期成果 (1-2週間後) - Phase 2完了時
- Heredoc機能の完全実装
- Export += 演算子の動作
- 環境変数展開の適切な処理
- テスター成功率70%→85%向上

### 中期成果 (1ヶ月後) - Phase 3準備完了時
- 全mandatory機能の完全実装
- bash互換性の大幅向上
- テスター成功率85%→95%向上
- Bonus機能実装方針の確定

### 長期成果 (2-3ヶ月後) - 最終完成時
- プロダクションレベルの安定性
- 選択的Bonus機能の実装
- 42課題としての完成度到達
- テスター成功率95%以上維持

## 🔄 継続的改善プロセス

### 週次振り返り
1. **成果の確認**: 計画 vs 実績
2. **問題の分析**: 遅延や不具合の根本原因
3. **プロセス改善**: 開発効率の向上策
4. **次週計画調整**: 優先度と工数の見直し

### 月次評価
1. **全体進捗評価**: マイルストーン達成度
2. **品質評価**: テスト結果とコード品質
3. **学習効果評価**: スキル向上と知識習得
4. **計画修正**: 残り期間でのスコープ調整

---

**Phase 1 完了**: 2025年6月14日 18:00  
**Phase 2 開始**: 2025年6月15日  
**次回レビュー**: 2025年6月21日  
**担当**: 42東京 minishell開発チーム